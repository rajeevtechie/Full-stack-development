(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))t(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&t(r)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function t(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}})();const{showOpenFilePicker:A,showSaveFilePicker:O}=typeof document=="object"?(()=>{if(globalThis.showOpenFilePicker)return globalThis;const e=new WeakMap,{FileSystemHandle:i=class{},FileSystemFileHandle:n=class extends i{}}=globalThis,t=document.createElement("input"),a=document.createElement("a"),o=c=>{const d=g(n.prototype);return e.set(d,c),d},r=c=>f(Object(c==null?void 0:c.accept)).join(","),s=(c,d)=>{t.click(),t.addEventListener("change",()=>{c([...t.files].map(o)),t.value=""},{once:!0}),t.addEventListener("cancel",()=>{d(new DOMException("The user aborted a request."))},{once:!0})},{create:g,defineProperties:l,getOwnPropertyDescriptors:w,values:f}=Object,{name:p,kind:b,...u}=w(i.prototype),{getFile:m,...h}=w(n.prototype);t.type="file",l(i.prototype,{...u,...w({get name(){var c;return((c=e.get(this))==null?void 0:c.name)??p.call(this)},get kind(){return e.has(this)?"file":b.call(this)}})}),l(n.prototype,{...h,...w({async getFile(){return await e.get(this)||m.call(this)},async createWritable(){const c=new j;return e.set(c,e.get(this)),c}})});class j extends WritableStream{constructor(){e.set(super({write:async d=>{const y=e.get(this);e.set(this,new File([y,d instanceof Blob||d instanceof Uint8Array||typeof d=="string"?d:ArrayBuffer.isView(d)||d instanceof ArrayBuffer?new Uint8Array(d):d instanceof DataView?new Uint8Array(d.buffer):new Uint8Array(new TextEncoder().encode(String(d)))],y.name,{type:y.type,lastModified:y.lastModified}))}}),new File([],"Untitled.txt",{type:"text/plain"}))}async write(d){const y=this.getWriter();await y.write(d),y.releaseLock()}async close(){const d=e.get(this),y=URL.createObjectURL(d);document.documentElement.append(a),a.href=y,a.download=d.name,a.type=d.type,a.click(),a.remove(),URL.revokeObjectURL(y)}}return{showOpenFilePicker(c=null){return t.multiple=!!(c!=null&&c.multiple),t.accept=[].concat((c==null?void 0:c.types)??[]).map(r).join(","),new Promise(s)},async showSaveFilePicker(c=null){var y,v;const d=[].concat(Object.entries(Object((y=[].concat((c==null?void 0:c.types)??[])[0])==null?void 0:y.accept)))[0]||["text/plain",[".txt"]];return o(new File([],(c==null?void 0:c.suggestedName)??"Untitled"+(((v=d==null?void 0:d[1])==null?void 0:v[0])||".txt"),{type:(d==null?void 0:d[0])||"text/plain"}))}}})():{async showOpenFilePicker(){return[]},async showSaveFilePicker(){return[]}};async function F(e,i,n){console.log(`Creating download for file: ${i}`);const t=atob(n),a=new Array(t.length);for(let l=0;l<t.length;l++)a[l]=t.charCodeAt(l);const o=new Uint8Array(a),r=new Blob([o],{type:"application/octet-stream"}),s=URL.createObjectURL(r),g=document.createElement("a");g.href=s,g.download=i,document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(s)}async function B(e,i,n,t,a){console.log("Recieved file to save");const o=await t.getFileHandleId();if(a)try{const r=await O({suggestedName:n,types:[{description:"Logisim Circuit Files",accept:{"application/octet-stream":[".circ"]}}]});if(await _(e,t,r))return;const g=await r.createWritable();if(await g.write(i),await g.close(),o==""){const l=crypto.randomUUID();await t.setFileHandleId(l),D(r,l)}else D(r,o);await t.setSavedLocally(!0),console.log("File saved successfully!"),await t.setName(r.name.replace(/\.circ$/,""))}catch(r){console.error("Failed to save file: ",r)}else{const s=await(await window.idb.openDB("fileHandlesDB",1)).get("files",o);if(!s){await B(e,i,n,t,!0);return}if(await _(e,t,s))return;try{const l=await s.queryPermission({mode:"readwrite"});if(l==="granted"||l==="prompt"){const w=await s.createWritable();await w.write(i),await w.close(),console.log("File saved successfully!"),await t.setName(s.name.replace(/\.circ$/,""))}else console.error("Save failed: Permission denied.")}catch(l){console.log(l);const w=await e.javax.swing.JOptionPane,f=await e.com.cburch.logisim.file.Strings;await w.showMessageDialog(null,"An error occured during saving - if you are on Firefox please save as",await f.get("fileSaveErrorTitle"),await w.ERROR_MESSAGE)}}}async function D(e,i){await(await window.idb.openDB("fileHandlesDB",1,{upgrade(t){t.objectStoreNames.contains("files")||t.createObjectStore("files")}})).put("files",e,i)}async function L(e,i){await(await window.idb.openDB("fileHandlesDB",1,{upgrade(t){t.objectStoreNames.contains("libraries")||t.createObjectStore("libraries")}})).put("libraries",e,i)}async function E(e,i,n,t){console.log("Saving file"),await B(e,i,n,t,!1)}async function J(e,i,n){try{const[t]=await A({suggestedName:"",types:[{description:"Logisim Circuit Files",accept:{"application/octet-stream":[".circ"]}}]});if(!t){console.log("No file selected.");return}console.log("Openning file");const a=await t.getFile(),o=await a.name,r=await a.arrayBuffer(),s=new Uint8Array(r);console.log("Preparing file for sending to Java");const g=await e.java.lang.Byte,l=await e.java.util.ArrayList;console.log("Building byte array");const w=await new l;for(let u=0;u<s.length;u++){const m=await new g(s[u]);await w.add(m)}console.log("Converting array");const f=await w.toArray();console.log("Data prepared... calling logisim method");const b=await(await e.com.cburch.logisim.proj.ProjectActions).doLocalOpen(i,n,f,o)}catch(t){console.log("Error openning file: ",t)}}async function U(e,i){try{const[n]=await A({suggestedName:"",types:[{description:"Logisim Circuit Files",accept:{"application/octet-stream":[".circ"]}}]});if(!n){console.log("No file selected.");return}console.log("Openning file");const t=await n.getFile(),a=await t.name,o=await t.arrayBuffer(),r=new Uint8Array(o);let s=await S(t);s||(s=crypto.randomUUID()),L(n,s),console.log("Preparing file for sending to Java");const g=await e.java.lang.Byte,l=await e.java.util.ArrayList;console.log("Building byte array");const w=await new l;for(let u=0;u<r.length;u++){const m=await new g(r[u]);await w.add(m)}console.log("Converting array");const f=await w.toArray();console.log("Data prepared... calling logisim method");const b=await(await e.com.cburch.logisim.gui.menu.ProjectLibraryActions).doLoadLocalLogisimLibrary(i,f,a,s)}catch(n){console.log("Error openning file: ",n)}}async function x(e,i){try{const[n]=await A({suggestedName:"",types:[{description:"Java Jar files",accept:{"application/octet-stream":[".jar"]}}]});if(!n){console.log("No file selected.");return}console.log("Openning file");const t=await n.getFile(),a=await t.arrayBuffer(),o=new Uint8Array(a);let r=await S(t);r||(r=crypto.randomUUID()),L(n,r),console.log("Preparing file for sending to Java");const s=await e.java.lang.Byte,g=await e.java.util.ArrayList;console.log("Building byte array");const l=await new g;for(let b=0;b<o.length;b++){const u=await new s(o[b]);await l.add(u)}console.log("Converting array");const w=await l.toArray();console.log("Data prepared... calling logisim method");const p=await(await e.com.cburch.logisim.gui.menu.ProjectLibraryActions).doLoadJarLibrary(i,w,r)}catch(n){console.log("Error during file openning: ",n)}}async function S(e){const i=await e.text(),a=new DOMParser().parseFromString(i,"application/xml").querySelector("project");return a?a.getAttribute("FileHandleId")||null:(console.warn("No <project> element found in XML."),null)}async function I(e,i,n){const[t,a]=i.split("#"),r=await(await window.idb.openDB("fileHandlesDB",1)).get("libraries",t);let s;try{let g=!1;try{r&&(s=await r.getFile(),g=!0)}catch{g=!1}if(!g){const c=await e.javax.swing.JOptionPane,d=await e.com.cburch.logisim.util.StringUtil,y=await e.com.cburch.logisim.file.Strings;await c.showMessageDialog(null,await d.format(await y.get("fileLibraryMissingError"),a));const[v]=await A({suggestedName:"",types:[{description:"Logisim Circuit Files",accept:{"application/octet-stream":[".circ"]}},{description:"Java Jar files",accept:{"application/octet-stream":[".jar"]}}]});if(!v)return console.log("No file selected."),null;console.log("Openning file"),s=await v.getFile()}const l=await s.arrayBuffer(),w=new Uint8Array(l);let f=await S(s);f||(f=crypto.randomUUID()),L(r,f),console.log("Preparing file for sending to Java");const p=await e.java.lang.Byte,b=await e.java.util.ArrayList;console.log("Building byte array");const u=await new b;for(let c=0;c<w.length;c++){const d=await new p(w[c]);await u.add(d)}console.log("Converting array");const m=await u.toArray(),j=await(await e.com.wasm.helpers.ByteArrayConverter).convertObjectToByteArray(m);if(console.log("Data prepared... calling logisim method"),s.name.endsWith(".jar"))return await(await e.com.cburch.logisim.file.LibraryManager).instance.loadJarLibrary(n,j,a,t);if(s.name.endsWith(".circ"))return await(await e.com.cburch.logisim.file.LibraryManager).instance.loadLogisimLibrary(n,j,a,t);{const d=s.name.split(".").pop(),y=await e.javax.swing.JOptionPane,v=await e.com.cburch.logisim.util.StringUtil,P=await e.com.cburch.logisim.file.Strings;return await y.showMessageDialog(null,await v.format(await P.get("fileTypeError"),d,s.name)),null}}catch{return console.error("Error finding library"),null}}async function _(e,i,n){const a=await(await e.com.cburch.logisim.file.LibraryManager).instance.findAllLocalReferences(i);for(let o=0;o<await a.length;o++){const r=await a[o],g=await(await window.idb.openDB("fileHandlesDB",1)).get("libraries",r);if(g)try{if(await g.isSameEntry(n)){console.log("handles: ",g,n);const l=await e.javax.swing.JOptionPane,w=await e.com.cburch.logisim.util.StringUtil,f=await e.com.cburch.logisim.file.Strings,p=await g.getFile();return await l.showMessageDialog(null,await w.format(await f.get("fileCircularError"),p.name),await f.get("fileSaveErrorTitle"),await l.ERROR_MESSAGE),!0}}catch{const l=await e.javax.swing.JOptionPane;return await e.com.cburch.logisim.file.Strings,await l.showMessageDialog(null,"Logisim was unable to check for circular references","Warning",await l.WARNING_MESSAGE),!1}}return!1}async function M(e){return window.JavaInstance=await e,window.ProjectActions=await e.com.cburch.logisim.proj.ProjectActions,console.log("Java instance set on JavaScript side"),new Promise(()=>{})}async function N(e,i){if(!window.JavaInstance){window.alert("Please wait for Logisim to launch");return}C(i);try{const n=await fetch(e),t=i,a=await n.body.getReader();let o=[],r=0;for(;;){const{done:m,value:h}=await a.read();if(m)break;o.push(h),r+=h.length}const s=new Uint8Array(r);let g=0;for(let m of o)s.set(m,g),g+=m.length;const l=s;console.log("Preparing file for sending to Java");const w=await window.JavaInstance.java.lang.Byte,f=await window.JavaInstance.java.util.ArrayList;console.log("Building byte array");const p=await new f;for(let m=0;m<l.length;m++){const h=await new w(l[m]);await p.add(h)}console.log("Converting array");const b=await p.toArray();console.log("Data prepared... calling logisim method");const u=await window.ProjectActions.doLocalOpen(null,null,b,t)}catch(n){console.error("Error occured loading example: ",n)}H(i),document.querySelectorAll("details").forEach(n=>{n.open=!1})}function C(e){const i=e.replace(/\s+/g,"-"),n=document.getElementById(`${i}-Button`),t=document.getElementById(`${i}-Img`),a=document.getElementById(`${i}-Spinner`);n.setAttribute("disabled","true"),t&&t.setAttribute("hidden","true"),a&&a.removeAttribute("hidden")}function H(e){const i=e.replace(/\s+/g,"-"),n=document.getElementById(`${i}-Button`),t=document.getElementById(`${i}-Img`),a=document.getElementById(`${i}-Spinner`);n.removeAttribute("disabled"),t&&t.removeAttribute("hidden"),a&&a.setAttribute("hidden","true")}document.getElementById("cheerp-container");window.addEventListener("beforeunload",e=>{e.preventDefault(),e.returnValue=""});window.idb=idb;window.loadExample=N;(async function(){for(await cheerpjInit({version:8,natives:{Java_com_cburch_logisim_gui_main_ExportImage_DownloadFile:F,Java_com_cburch_logisim_gui_menu_MenuFile_SendFileData:B,Java_com_cburch_logisim_proj_ProjectActions_SendFileData:E,Java_com_cburch_logisim_gui_menu_MenuFile_openFolder:J,Java_com_cburch_logisim_gui_menu_MenuProject_openFolder:U,Java_com_cburch_logisim_gui_menu_ProjectLibraryActions_openJarLibrary:x,Java_com_cburch_logisim_gui_start_Startup_setJava:M,Java_com_cburch_logisim_file_LibraryManager_findLocalLibrary:I}}),cheerpjCreateDisplay(-1,-1,document.getElementById("cheerp-container"));;)await cheerpjRunJar("/app/logisim.jar")})();(async function(){const e="fileHandlersDB",i="fileHandlesDB";if(await new Promise(t=>{const a=indexedDB.open(e);let o=!0;a.onupgradeneeded=()=>{o=!1},a.onsuccess=()=>{a.result.close(),o||indexedDB.deleteDatabase(e),t(o)},a.onerror=()=>t(!1)})){const t=await window.idb.openDB(e),a=await window.idb.openDB(i,1,{upgrade(r){r.objectStoreNames.contains("files")||r.createObjectStore("files"),r.objectStoreNames.contains("libraries")||r.createObjectStore("libraries")}}),o=async(r,s)=>{if(!t.objectStoreNames.contains(r))return;const g=t.transaction(r,"readonly"),l=g.objectStore(r),w=await l.getAllKeys(),f=await Promise.all(w.map(u=>l.get(u)));await g.done;const p=a.transaction(s,"readwrite"),b=p.objectStore(s);for(let u=0;u<w.length;u++)b.put(f[u],w[u]);await p.done};await o("handlers","files"),await o("library","libraries"),t.close(),await indexedDB.deleteDatabase(e),console.log("Migration from fileHandlersDB to fileHandlesDB completed.")}else await window.idb.openDB(i,1,{upgrade(t){t.objectStoreNames.contains("files")||t.createObjectStore("files"),t.objectStoreNames.contains("libraries")||t.createObjectStore("libraries")}}),console.log("fileHandlesDB initialized (no migration needed).")})();
